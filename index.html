<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Alaska Climate and Weather Highlights</title>
  <script src="jquery-3.2.0.min.js"></script>
  <script src="moment.min.js"></script>
  <script src="Cesium/Cesium.js"></script>
  <style>
      @import url(Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }

      .cesium-infoBox {
        top: 10px;
        right: 10px;
      }
  </style>
</head>
<body>
  <span style="position: absolute; top: 0; left: 25px; z-index: 1; color: #fff; font-family: sans-serif; text-shadow: 0px 0px 10px #000;">
    <h1 style="margin-bottom: 0;">Alaska Climate and Weather Highlights</h1>
    <h2 id="highlight-month" style="margin-top: 0;"></h2>
  </span>
  <div id="cesiumContainer"></div>
  <script>
    var icons;
    var viewer;
    var highlightMoment;
    var monthOffset = 0;
    var highlights;

    function initialize() {
      Cesium.BingMapsApi.defaultKey = '...';

      icons = {
        'high-temperatures': 'high_temperature.png',
        'wind': 'high_winds.png',
        'high-snow': 'snow.png',
        'sea-ice-changes': 'sea_ice.png'
      }

      viewer = new Cesium.Viewer('cesiumContainer', {
        animation: false,
        baseLayerPicker: false,
        fullscreenButton: false,
        geocoder: false,
        homeButton: false,
        navigationHelpButton: false,
        sceneModePicker: false,
        timeline: false,
        vrButtin: false
      });

      var frame = viewer.infoBox.frame;

      frame.addEventListener('load', function () {
        var cssLink = frame.contentDocument.createElement('link');
        cssLink.href = Cesium.buildModuleUrl('../css/infobox.css');
        cssLink.rel = 'stylesheet';
        cssLink.type = 'text/css';
        frame.contentDocument.head.appendChild(cssLink);
      }, false);

      getHighlights();
    }

    function getHighlights() {
      highlightMoment = moment().subtract(monthOffset, 'months').startOf('month');
      var month = highlightMoment.format('YYYY-MM');

      jQuery.getJSON({
        dataType: 'json',
        url: '/climate-highlights/' + month + '/' + month,
        success: function(data) {
          if(data.highlights.length > 0) {
            $('#highlight-month').html(highlightMoment.format('MMMM YYYY'));
            highlights = data.highlights;
            monthOffset = 0;
            setTimeout(getHighlights, 10000);
          } else {
            monthOffset++;
            getHighlights();
          }
        }
      })
    }

    function displayHighlights() {
      var index = 0;
      var dataSource = new Cesium.CustomDataSource("my data")

      highlights.forEach(function (highlight) {
        dataSource.entities.add({
          position: new Cesium.Cartesian3.fromDegrees(highlight.lon, highlight.lat),
          name: highlight.summary,
          description: highlight.description,
          billboard: {
            image: 'images/' + icons[highlight.kind],
            scale: 0.5
          }
        });
      });

      viewer.dataSources.add(dataSource);

      fly();

      function fly () {
        index = (index + 1) % highlights.length;
        var pointAbove = Cesium.Cartesian3.fromDegrees(highlights[index].lon, highlights[index].lat, 250000);

        viewer.camera.flyTo({
          destination: pointAbove,
          duration: 8,
          complete: function() {
            viewer.selectedEntity = dataSource.entities.values[index];
          }
        });

        setTimeout(fly, 10000);
      }
    }

    function start() {
      if(highlights === undefined) {
        setTimeout(start, 1000);
      } else {
        displayHighlights();
      }
    }

    initialize();
    start();
  </script>
</body>
</html>
